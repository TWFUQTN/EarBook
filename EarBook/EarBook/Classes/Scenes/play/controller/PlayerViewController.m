//
//  PlayerViewController.m
//  EarBook
//
//  Created by lanou3g on 16/6/24.
//  Copyright ¬© 2016Âπ¥ ËµµÁ¨¶Â£π. All rights reserved.
//

#import "PlayerViewController.h"
#import "AVPlayerManager.h"
#import <UIImageView+WebCache.h>
#import "NSString+TimeFormatter.h"
#import "BookInfosHandle.h"
#import "DetailViewController.h"
#import "HomeViewController.h"
#import <UMSocial.h>


#import <MediaPlayer/MediaPlayer.h>

//BookInfoHandleÁöÑÂçï‰æã
#define kBookInfosHandle [BookInfosHandle shareBookInfosHandle]

// AVPlayerManagerÁöÑÂçï‰æã
#define kAVPlayerManager [AVPlayerManager shareAVPlayerManager]
@interface PlayerViewController () <AVPlayerManagerDelegate, UMSocialUIDelegate>
//Èü≥ÈáèÊéßÂà∂Âô®
@property (nonatomic, strong) MTTCircularSlider* defaultSlider;
//ËÉåÊôØÂõæÁâá
@property (weak, nonatomic) IBOutlet UIImageView *backgroundImageView;
//Êí≠ÊîæÂõæÁâá
@property (weak, nonatomic) IBOutlet UIButton *playButton;
//‰∏ã‰∏ÄÈ¶ñÊåâÈíÆ
@property (weak, nonatomic) IBOutlet UIButton *nextButton;
//‰∏ä‰∏ÄÈ¶ñÊåâÈíÆ
@property (weak, nonatomic) IBOutlet UIButton *lastButton;
//Ê≠åÊõ≤ÂõæÁâá
@property (weak, nonatomic) IBOutlet UIImageView *songImageView;
//ÂºÄÂßãÊó∂Èó¥
@property (weak, nonatomic) IBOutlet UILabel *beginTimeLabel;
//ÁªìÊùüÊó∂Èó¥
@property (weak, nonatomic) IBOutlet UILabel *endTimeLabel;
//Êí≠ÊîæËøõÂ∫¶
@property (weak, nonatomic) IBOutlet UISlider *progressSlider;
//Â£∞Èü≥ÊåâüêÇ
@property (weak, nonatomic) IBOutlet UIButton *soundButton;

//ÊòØÂê¶ÊúâÂ£∞Èü≥
@property (nonatomic,assign)BOOL isSound;
//‰π¶Âêç
@property (weak, nonatomic) IBOutlet UILabel *bookName;
//ÂΩìÂâçÈõÜÊï∞
@property (weak, nonatomic) IBOutlet UILabel *bookCurrent;
//ÂΩìÂâçMP3ÁöÑÈïøÂ∫¶
@property (nonatomic ,assign) CGFloat mp3Time;
//ËÆæÁΩÆÊòØÂê¶ÈöêËóè
@property (nonatomic, assign) BOOL isSettingHide;


@end

@implementation PlayerViewController


- (void)viewDidAppear:(BOOL)animated {
   
}
- (void)viewWillAppear:(BOOL)animated {
    self.navigationController.navigationBarHidden = YES;
    // ËÆæÁΩÆ‰ª£ÁêÜ
    kAVPlayerManager.delegate = self;

    // Â£∞Èü≥Âä†ËΩΩ
    [self addDefaultSlider];

    // Êí≠ÊîæÂπ∂ËÆæÁΩÆview‰∏äÊâÄÊúâÂ≠êËßÜÂõæ
    [self playAndSetUpViews];
    [self otherSetting];
    
}
//ÂÖ∂‰ªñËÆæÁΩÆ
- (void)otherSetting{
    [_progressSlider setThumbImage:[UIImage imageNamed:@"thumb.png"] forState:UIControlStateNormal];
    _progressSlider.maximumTrackTintColor = [UIColor whiteColor];
    _progressSlider.minimumTrackTintColor = [UIColor redColor];
    _playSettingView.layer.cornerRadius = 20;
    _playSettingView.layer.masksToBounds = YES;
    _playSettingView.hidden = YES;
    _isSettingHide = YES;
   
}
- (void)viewDidLoad {
    [super viewDidLoad];
    // ËÆæÁΩÆ‰ª£ÁêÜ
}
// Êí≠ÊîæÂπ∂ËÆæÁΩÆview‰∏äÊâÄÊúâÂ≠êËßÜÂõæ
- (void)playAndSetUpViews {
    _index = kBookInfosHandle.indexout;
    _bookList = kBookInfosHandle.bookInfosArray[_index];
//    _bookList = _playList[_index];
    _bookInformation = kBookInfosHandle.bookMP3;

    [kAVPlayerManager playWithUrl:_bookList.path currentIndex:self.index];
    // ÊîπÂèòÊí≠ÊîæÊåâÈíÆÁöÑÁä∂ÊÄÅ
    [_playButton setImage:[UIImage imageNamed:@"playPause"] forState:UIControlStateNormal];
//    ‰∏≠ÂøÉÂõæÁâá
    _songImageView.layer.cornerRadius = 100;
    _songImageView.layer.masksToBounds = YES;
    _songImageView.layer.borderWidth = 1;
    [_songImageView sd_setImageWithURL:[NSURL URLWithString:_bookInformation.cover]];
// Âê¨‰π¶ÂêçÁß∞
    _bookName.text = _bookInformation.name;
//    ËÉåÊôØÊ®°Á≥äÂ§ÑÁêÜ
    CIContext *context = [CIContext contextWithOptions:nil];
    NSURL *imageURL = [NSURL URLWithString:_bookInformation.cover];
    CIImage *image = [CIImage imageWithContentsOfURL:imageURL];
    CIFilter *filter = [CIFilter filterWithName:@"CIGaussianBlur"];
    [filter setValue:image forKey:kCIInputImageKey];
    [filter setValue:@2.0f forKey: @"inputRadius"];
    CIImage *result = [filter valueForKey:kCIOutputImageKey];
    CGImageRef outImage = [context createCGImage: result fromRect:[result extent]];
    UIImage * blurImage = [UIImage imageWithCGImage:outImage];

    _backgroundImageView.image = blurImage;
//   ÈõÜÊï∞
    _bookCurrent.text = _bookList.name;
    // ËÆæÁΩÆtimeSlider
    _progressSlider.minimumValue = 0.0;
    _mp3Time = [kAVPlayerManager getMp3TimeOfurl:_bookList.path];
    _progressSlider.maximumValue = _mp3Time;
    _progressSlider.value = 0;
    
    [kBookInfosHandle getNowDate];
    NSLog(@"%@",kBookInfosHandle.nowDate);

    
}
#pragma mark - ÂºÄÂßãËΩ¨Âä®
- (void)beginimagerevole{
    
    [NSTimer scheduledTimerWithTimeInterval:0.1 target:self selector:@selector(imageViewRevolve) userInfo:nil repeats:YES];
}
- (void)imageViewRevolve{
    [UIView animateWithDuration:0.1 animations:^{
        _songImageView.transform = CGAffineTransformRotate(_songImageView.transform,  -M_PI / 100);
    }];
}
#pragma mark - ËøõÂ∫¶Êù°slider
- (IBAction)progressChange:(id)sender {
    
    [kAVPlayerManager seekToTime:_progressSlider.value];
    
}

#pragma mark - Â£∞Èü≥Âä†ËΩΩ
- (void)addDefaultSlider{
    
    _defaultSlider = [MTTCircularSlider new];
    _defaultSlider.lineWidth = 5;
    _defaultSlider.angle = 45;
//    _defaultSlider.maxValue = 5;
//    _defaultSlider.minValue = 0;
    _defaultSlider.selectColor = [UIColor redColor];
    _defaultSlider.unselectColor = [UIColor whiteColor];
    _defaultSlider.tag = 1;
    _defaultSlider.minValue = 0.0;
    _defaultSlider.maxValue = 1.0;
    _defaultSlider.value = [kAVPlayerManager volume];
    [self.view addSubview:_defaultSlider];
    [self.view bringSubviewToFront:_playButton];
    [_defaultSlider addTarget:self action:@selector(sliderValueChanged) forControlEvents:UIControlEventValueChanged];
    [_defaultSlider mas_makeConstraints:^(MASConstraintMaker *make) {
        make.centerX.equalTo(_playButton.mas_centerX);
        make.centerY.equalTo(_playButton.mas_centerY);
        make.width.mas_equalTo(100);
        make.height.mas_equalTo(100);
    }];
    
}

#pragma mark - ÂõûÂà∞‰∏ä‰∏ÄÂ±Ç
- (IBAction)backAction:(id)sender {
    [self.navigationController popViewControllerAnimated:YES];
}
#pragma mark - ËÆæÁΩÆÊåâÈíÆ
- (IBAction)settingAction:(id)sender {
    if (_isSettingHide == YES) {
        _playSettingView.hidden = NO;
        _isSettingHide = NO;
    }
    else {
        _playSettingView.hidden = YES;
        _isSettingHide = YES;
    }
    
}
#pragma mark - Â£∞Èü≥ÊåâÈíÆ
- (IBAction)soundAction:(id)sender {
    if (_defaultSlider.value > 0) {
        [_soundButton setImage:[UIImage imageNamed:@"playnosound"] forState:UIControlStateNormal];
        _isSound = NO;
        _defaultSlider.value = 0;
        kAVPlayerManager.volume = _defaultSlider.value;
    }
    else {
        [_soundButton setImage:[UIImage imageNamed:@"playsound"] forState:UIControlStateNormal];
        _defaultSlider.value = 0.5;
        kAVPlayerManager.volume = _defaultSlider.value;
        _isSound = YES;
    }
    
}
#pragma mark - Êü•Êâæ
- (IBAction)searchAction:(id)sender {

}
#pragma mark - Êî∂Ëóè
- (IBAction)likeAction:(id)sender {
    
    
    UIAlertController *alertC = [UIAlertController alertControllerWithTitle:@"Êî∂Ëóè" message:@"ÊòØÂê¶Êî∂Ëóè" preferredStyle:UIAlertControllerStyleAlert];
    UIAlertAction *alertA = [UIAlertAction actionWithTitle:@"Á°ÆËÆ§" style:UIAlertActionStyleDefault handler:^(UIAlertAction * _Nonnull action) {
        AVObject *todo = [AVObject objectWithClassName:@"like"];
        [todo setObject:[AVUser currentUser].username forKey:@"username"];
        [todo setObject:kBookInfosHandle.bookMP3.name forKey:@"bookName"];
        [todo setObject:kBookInfosHandle.bookMP3.ID forKey:@"bookID"];
        [todo setObject:kBookInfosHandle.bookMP3.cover forKey:@"bookImageURL"];
        [todo saveInBackgroundWithBlock:^(BOOL succeeded, NSError *error) {
            if (succeeded) {
                NSLog(@"%@",todo.objectId);// ‰øùÂ≠òÊàêÂäü‰πãÂêéÔºåobjectId ‰ºöËá™Âä®‰ªé‰∫ëÁ´ØÂä†ËΩΩÂà∞Êú¨Âú∞
            }
        }];
    }];
    UIAlertAction *alertB = [UIAlertAction actionWithTitle:@"ÂèñÊ∂à" style:UIAlertActionStyleDefault handler:^(UIAlertAction * _Nonnull action) {
        
    }];
    
    
    [alertC addAction:alertA];
    [alertC addAction:alertB];
    [self presentViewController:alertC animated:YES completion:nil];

}
#pragma mark - Âà†Èô§
- (IBAction)trashAction:(id)sender {
    
}
#pragma mark - ÂàÜ‰∫´
- (IBAction)shareAction:(id)sender {
    
    [UMSocialData defaultData].extConfig.title = _bookName.text;
    
    NSString *shareText = @"";
    if (_bookCurrent.text.length > 140) {
        shareText = [_bookCurrent.text substringToIndex:140];
    } else {
        shareText = _bookCurrent.text;
    }
    
    [UMSocialSnsService presentSnsIconSheetView:self
                                         appKey:@"57767a3667e58e180b0006c2"
                                      shareText:shareText
                                     shareImage:_backgroundImageView.image
                                shareToSnsNames:@[UMShareToWechatSession,UMShareToSina,UMShareToQQ,UMShareToQzone]
                                       delegate:self];
    
}

#pragma mark - ÂàóË°®ÊåâÈíÆ
- (IBAction)listAction:(id)sender {
    DetailViewController *detaVC = [[DetailViewController alloc]init];
    detaVC.book = kBookInfosHandle.bookMP3;
    
    detaVC.pushFrom = PushFromMoreListVC;
    detaVC.pageNum = 1;
    detaVC.listTableView.contentOffset = CGPointMake(0, 200);
    detaVC.bottomScrollView.contentOffset = CGPointMake(detaVC.view.frame.size.width, 0);
    [self.navigationController pushViewController:detaVC animated:YES];

}


#pragma mark - Êí≠ÊîæÊåâÈíÆ
- (IBAction)playAction:(id)sender {

    if (kAVPlayerManager.status == isPaused || kAVPlayerManager.status == isStoped) {
        [kAVPlayerManager play];
        [_playButton setImage:[UIImage imageNamed:@"playPause"] forState:UIControlStateNormal];
    } else if (kAVPlayerManager.status == isPlaying) {
        [kAVPlayerManager pause];
        [_playButton setImage:[UIImage imageNamed:@"playPlay"] forState:UIControlStateNormal];
    }

}
#pragma mark ‰∏ä‰∏ÄÈ¶ñ
- (IBAction)nextButton:(id)sender {
    _bookList = [kBookInfosHandle bookInfoNextWithIndex:&_index];

    [self playAndSetUpViews];

}
#pragma mark ‰∏ã‰∏ÄÈ¶ñ
- (IBAction)lastButton:(id)sender {
    _bookList = [kBookInfosHandle bookInfoPreviousWithIndex:&_index];


    [self playAndSetUpViews];
}

#pragma mark Â£∞Èü≥Ë∞ÉËäÇ

- (void)sliderValueChanged{
    kAVPlayerManager.volume = _defaultSlider.value;
//    kAVPlayerManager.volume = [self getVolumeLevel];
    if (kAVPlayerManager.volume > 0 ) {
        [_soundButton setImage:[UIImage imageNamed:@"playsound"] forState:UIControlStateNormal];
        _isSound = YES;
    }
}

- (void)playDidFinished {
    // Ê†πÊçÆÊ®°ÂºèÂèñÂá∫‰∏ã‰∏ÄÈ¶ñÊí≠ÊîæÁöÑmusic
    [self getMusicByLoopMode];
}

#pragma mark - ÂÆöÊó∂Âô®ÊîπÂèòÊó∂Èó¥
- (void)changeTime:(CGFloat)time {
    // ÊîπÂèòsilderÁöÑ‰ΩçÁΩÆ
    _progressSlider.value = time;
    _beginTimeLabel.text = [NSString getStringWithTime:time];
    _endTimeLabel.text = [NSString getStringWithTime:_mp3Time ];
    
    // ËΩ¨Âä®imageView
    [UIView animateWithDuration:0.1 animations:^{
        _songImageView.transform = CGAffineTransformRotate(_songImageView.transform, 0.05);
    }];
}

#pragma mark - Ê†πÊçÆÊí≠ÊîæÊ®°ÂºèÂèñÂá∫‰∏ã‰∏ÄÈ¶ñÊí≠ÊîæÁöÑmusic
- (void)getMusicByLoopMode {
    switch (kAVPlayerManager.loopMode) {
        case LoopModeOrderMode:
            _bookList = [kBookInfosHandle bookInfoNextWithIndex:&_index];
            [self playAndSetUpViews];
            break;
        case LoopModeSingleMond:
            [self playAndSetUpViews];
            break;
        case LoopModeRandomMode:
            [self playAndSetUpViews];
            break;
        default:
            NSLog(@"Êú™Áü•Êí≠ÊîæÊ®°ÂºèÔºåËØ∑ËÆæÁΩÆ");
            break;
    }
}

- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
}

@end
